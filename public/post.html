<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê²Œì‹œê¸€ ìƒì„¸</title>
</head>
<body>
  <div id="post"></div>

  <h3>ğŸ’¬ ëŒ“ê¸€</h3>
  <ul id="comment-list"></ul>

  <form id="comment-form" style="display: none;">
    <input type="text" id="comment-content" placeholder="ëŒ“ê¸€ ì…ë ¥">
    <button type="submit">ë“±ë¡</button>
  </form>

  <script>
  const urlParams = new URLSearchParams(location.search);
  const postId = urlParams.get('id');
  let currentUser = null;

  async function loadPost() {
    const res = await fetch(`/api/posts/${postId}`);
    if (!res.ok) {
      document.getElementById('post').innerHTML = '<p>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    const { post, comments } = await res.json();

    document.getElementById('post').innerHTML = `
      <h2>${post.title}</h2>
      <p>ğŸ‘¤ ${post.username} | ğŸ•’ ${post.created_at.slice(0, 10)} | â¤ï¸ ${post.likes}</p>
      <p>${post.content}</p>
    `;comments

    const list = document.getElementById('comment-list');
    list.innerHTML = '';
    comments.forEach(c => {
      const li = document.createElement('li');
      li.innerHTML = `ğŸ—¨ï¸ ${c.username} (${c.created_at.slice(0, 10)}): ${c.content}`;

      if (currentUser && currentUser.id === c.user_id) {
        const btn = document.createElement('button');
        btn.textContent = 'ì‚­ì œ';
        btn.onclick = () => deleteComment(postId, c.id);
        li.appendChild(btn);
      }

      list.appendChild(li);
    });
    console.log(comments);
    console.log(currentUser);

  }

  async function checkLogin() {
    const res = await fetch('/api/auth/me');
    if (res.ok) {
      currentUser = await res.json();
      document.getElementById('comment-form').style.display = 'block';
    }
  }

  document.getElementById('comment-form').onsubmit = async (e) => {
    e.preventDefault();
    const content = document.getElementById('comment-content').value;
    const res = await fetch(`/api/posts/${postId}/comments`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    });
    if (res.ok) {
      document.getElementById('comment-content').value = '';
      loadPost();
    } else {
      alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
    }
  };

  function deleteComment(postId, commentId) {
    if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;

    fetch(`/api/posts/${postId}/comments/${commentId}`, {
      method: 'DELETE'
    }).then(res => {
      if (res.ok) loadPost();
      else alert('ì‚­ì œ ì‹¤íŒ¨');
    });
  }

  loadPost();
  checkLogin();
</script>

</body>
</html>
